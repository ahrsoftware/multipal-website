{% extends "base.html" %}
{% load static %}

{% block main %}

<div id="detail-images">
    <!-- Image Controls -->
    <div id="detail-images-controls" class="detail-controls">

        <!-- Choose Image -->
        <div id="detail-images-controls-chooseimage" class="detail-controls-item">
            <select{% if object.count_documentimages < 2 %} style="display: none;"{% endif %}>
                {% for document_image in object.documentimage_set.all %}
                    <option value="{{ document_image.id }}">Image {{ forloop.counter }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Reset Viewer -->
        <div id="detail-images-controls-reset" class="detail-controls-item" title="Reset Image"><i class="fas fa-redo-alt"></i></div>
        <!-- Download Image -->
        <div id="detail-images-controls-downloadimage" class="detail-controls-item" title="Download Image">
            <a href="{{ object.default_image.image.url }}" download><i class="fas fa-download"></i></a>
        </div>
        {% if user.is_authenticated %}
            <!-- Add New Document Image Part/Transcription -->
            <div id="detail-images-controls-newdocumentimagepart" class="detail-controls-item" title="Add New Transcription"><i class="fas fa-plus-square"></i></div>
        {% endif %}

        <!-- Zoom -->
        <div id="detail-images-controls-zoom">
            <!-- Zoom: Out -->
            <div id="detail-images-controls-zoom-out" class="detail-controls-item" title="Zoom Out"><i class="fas fa-search-minus"></i></div>
            <!-- Zoom: Slider -->
            <div id="detail-images-controls-zoom-range" class="detail-controls-item" title="Zoom">
                <input type="range" id="detail-images-controls-zoom-range-slider" title="detail-images-controls-zoom-range-slider" min="10" max="1000" value="100">
            </div>
            <!-- Zoom: In -->
            <div id="detail-images-controls-zoom-in" class="detail-controls-item" title="Zoom In"><i class="fas fa-search-plus"></i></div>
        </div>
    </div>
    <div id="detail-images-container">
        {% for document_image in object.documentimage_set.all %}
            <div id="detail-images-image-{{ document_image.id }}" class="detail-images-image">
                <img src="{{ document_image.image.url }}" alt="{{ document_image.alternative_text }}">
                <div class="detail-images-image-parts">
                    {% for document_image_part in document_image.documentimagepart_set.all %}
                        <div id="detail-images-image-parts-part-{{ document_image_part.id }}" class="detail-images-image-parts-part" style="top: {{ document_image_part.image_cropped_top }}px; left: {{ document_image_part.image_cropped_left }}px; width: {{ document_image_part.image_cropped_width }}px; height: {{ document_image_part.image_cropped_height }}px;"></div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div id="detail-details">

    <section id="transcription-exercise">
        <!-- Navigation -->
        <div id="detail-navigation">
            <a href="{{ navigate_all_url }}"><i class="fas fa-th"></i> All</a>
            <a href="{{ navigate_previous_url }}"><i class="fas fa-chevron-left"></i> Previous</a>
            <a href="{{ navigate_next_url }}">Next <i class="fas fa-chevron-right"></i></a>
        </div>
        <!-- Title -->
        <div id="transcription-exercise-title">{{ object }}</div>
        <!-- Tabs -->
        <ul class="tabs">
            <li id="transcription">Transcription</li><!--
            --><li id="information">Information</li><!--
            --><li id="comments">Comments</li><!--
            -->{% if request.user.is_staff %}<li id="admin">Admin</li>{% endif %}
        </ul>
    </section>

    <section class="tabbed" id="tabbed-transcription">
        <div class="tabbed-title">Transcription</div>
        <!-- Transcription Controls -->
        <div id="transcription-exercise-controls" class="detail-controls">
            <!-- Reset Transcription -->
            <div id="transcription-exercise-controls-reset" class="detail-controls-item" title="Reset Transcription"><i class="fas fa-redo-alt"></i></div>
            <!-- Instructions -->
            <div id="transcription-exercise-controls-instructions" class="detail-controls-item" title="Instructions"><i class="fas fa-info-circle"></i></div>
            <!-- Full Solution Text -->
            <div id="transcription-exercise-controls-fullsolution" class="detail-controls-item" title="Full Solution"><i class="fas fa-scroll"></i></div>
            <!-- All Correct Answers -->
            <div id="transcription-exercise-controls-correctall" class="detail-controls-item" title="All Correct Answers"><i class="fas fa-check-double"></i></div>
            <!-- Current Correct Answer -->
            <div id="transcription-exercise-controls-correctcurrent" class="detail-controls-item" title="Current Correct Answer"><i class="fas fa-check"></i></div>
            <!-- Position Details -->
            <div id="transcription-exercise-controls-positiondetails" class="detail-controls-item" title="Position Details"><i class="fas fa-list-ol"></i></div>
            <!-- Scores -->
            <div id="transcription-exercise-controls-scores" class="detail-controls-item" title="Scores"><i class="fas fa-star"></i></div>
            <!-- Core Info -->
            <div id="transcription-exercise-controls-coreinfo" class="detail-controls-item">
                <div>
                    <label>Author</label>
                    <span>{{ object.meta_created_by }}</span>
                </div>
                <div>
                    <label>Difficulty</label>
                    <span>{{ object.difficulty }}</span>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div id="transcription-exercise-instructions" class="transcription-exercise-controlsdropdown">
            <label>Instructions</label>
            <div>
                {{ object.instructions | safe | linebreaksbr }}
            </div>
        </div>

        <!-- Scores -->
        <div id="transcription-exercise-scores" class="transcription-exercise-controlsdropdown">
            <label>Score <span id="transcription-exercise-scores-percentage"></span></label>
            <div>Total available: <span id="transcription-exercise-scores-available"></span></div>
            <div>Total unanswered: <span id="transcription-exercise-scores-unanswered"></span></div>
            <div>Total answered: <span id="transcription-exercise-scores-answered"></span></div>
            <div>Total wrong: <span id="transcription-exercise-scores-wrong"></span></div>
            <div>Total correct: <span id="transcription-exercise-scores-correct"></span></div>
        </div>

        <!-- Solutions -->
        <div id="transcription-exercise-solutions" class="transcription-exercise-controlsdropdown">
            {% for document_image in object.documentimage_set.all %}
                <div id="transcription-exercise-solutions-solution-{{ document_image.id }}" class="transcription-exercise-solutions-solution{% if document_image.right_to_left %} dir-rtl{% else %} dir-ltr{% endif %}" dir="{% if document_image.right_to_left %}rtl{% else %}ltr{% endif %}">
                    <label>Full Solution: Image {{ forloop.counter }}</label>
                    <div>
                        {{ document_image.correct_transcription | safe | linebreaksbr }}
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Exercises -->
        {% for document_image in object.documentimage_set.all %}
            <div id="transcription-exercise-{{ document_image.id }}" class="transcription-exercise{% if document_image.right_to_left %} dir-rtl{% else %} dir-ltr{% endif %}" dir="{% if document_image.right_to_left %}rtl{% else %}ltr{% endif %}">
                <!-- Input -->
                <div class="transcription-exercise-input">
                    {% for document_image_part in document_image.documentimagepart_set.all %}
                        {% if document_image_part.is_first_in_line %}
                            {% if not document_image_part.is_first_in_image %}</div>{% endif %}
                            <div class="transcription-exercise-input-linecount">Line {{ document_image_part.line_count }}</div>
                            <div class="transcription-exercise-input-line">
                        {% endif %}
                        <!-- Before part -->
                        {% if document_image_part.text_before_part %}
                            <div class="transcription-exercise-input-line-beforepart">
                                <div id="transcription-exercise-input-line-word-beforepart-{{ document_image_part.id }}" class="transcription-exercise-input-line-word-beforepart">
                                    {{ document_image_part.text_before_part }}
                                </div>
                                <div id="transcription-exercise-input-line-word-answer-beforepart-{{ document_image_part.id }}" class="transcription-exercise-input-line-word-answer-beforepart">
                                    {{ document_image_part.text_before_part }}
                                </div>
                            </div>
                        {% endif %}
                        <!-- Part -->
                        <div class="transcription-exercise-input-line-part">
                            <!-- Part - Count -->
                            <div class="transcription-exercise-input-line-word-count">{{ document_image_part.part_count_in_line }}</div>
                            <!-- Part - Input -->
                            <input id="transcription-exercise-input-line-word-{{ document_image_part.id }}" class="transcription-exercise-input-line-word" type="text" size="{{ document_image_part.word_length }}" title="Transcribe this part of the image" data-correctanswer="{{ document_image_part.text }}"{% if document_image_part.help_text %} data-helptext="{{ document_image_part.help_text }}"{% endif %}>
                            <!-- Part - Answer -->
                            <div id="transcription-exercise-input-line-word-answer-{{ document_image_part.id }}" class="transcription-exercise-input-line-word-answer">{{ document_image_part.text }}</div>
                        </div>
                        <!-- After part -->
                        {% if document_image_part.text_after_part %}
                            <div class="transcription-exercise-input-line-afterpart">
                                <div id="transcription-exercise-input-line-word-afterpart-{{ document_image_part.id }}" class="transcription-exercise-input-line-word-afterpart">
                                    {{ document_image_part.text_after_part }}
                                </div>
                                <div id="transcription-exercise-input-line-word-answer-afterpart-{{ document_image_part.id }}" class="transcription-exercise-input-line-word-answer-afterpart">
                                    {{ document_image_part.text_after_part }}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    </div>
                </div>
                <!-- Popup -->
                <div id="transcription-exercise-part-popup">
                    <img id="transcription-exercise-part-popup-image" src="" alt="Document image part preview">
                    <div id="transcription-exercise-part-popup-helptext"></div>
                </div>
            </div>
        {% endfor %}
    </section>

    <section class="tabbed" id="tabbed-information">
        <div class="tabbed-title">Information</div>

        <div id="information-content">
            <div>
                <label>Name:</label>
                <span>{{ object.name }}</span>
            </div>
            {% if object.m2m_as_text_repositories %}
                <div>
                    <label>Repository:</label>
                    <span>{{ object.m2m_as_text_repositories }}</span>
                </div>
            {% endif %}
            {% if object.shelfmark %}
                <div>
                    <label>Shelf Mark:</label>
                    <span>{{ object.shelfmark }}</span>
                </div>
            {% endif %}
            {% if object.type %}
                <div>
                    <label>Type:</label>
                    <span>{{ object.type }}</span>
                </div>
            {% endif %}
            {% if object.difficulty %}
                <div>
                    <label>Tutorial Difficulty:</label>
                    <span>{{ object.difficulty }}</span>
                </div>
            {% endif %}
            {% if object.m2m_as_text_languages %}
                <div>
                    <label>Language/Script:</label>
                    <span>{{ object.m2m_as_text_languages }}</span>
                </div>
            {% endif %}
            {% if object.ink %}
                <div>
                    <label>Language/Script:</label>
                    <span>{{ object.ink }}</span>
                </div>
            {% endif %}
            {% if object.partial_date_range %}
                <div>
                    <label>Date Range:</label>
                    <span>{{ object.partial_date_range }}</span>
                </div>
            {% endif %}
            {% if object.date %}
                <div>
                    <label>Date:</label>
                    <span>{{ object.date }}</span>
                </div>
            {% endif %}
            {% if object.information %}
                <div>
                    <label>Information:</label>
                    <span>{{ object.information | safe | linebreaks }}</span>
                </div>
            {% endif %}
        </div>
    </section>

    <section class="tabbed" id="tabbed-comments">
        <div class="tabbed-title">Comments</div>
        Comments
    </section>

    {% if request.user.is_staff %}
        <section class="tabbed" id="tabbed-admin">
            <div class="tabbed-title">Admin</div>
            Admin stuff
        </section>
    {% endif %}

</div>

<script src="{% static 'js/tabs.js' %}"></script>

<script>
$(document).ready(function(){

    var lastActiveDocumentImagePartId;
    var showCorrectAnswerInlineIndividual = false;
    var showCorrectAnswerInlineAll = false;

    $('.detail-controls div').attr('data-placement', 'bottom').tooltip();

    // Transcription Controls functionality
    // Clear transcription attempts
    $('#transcription-exercise-controls-reset').on('click', function(){
        $('.transcription-exercise-input-line-word').each(function(){$(this).val('').removeClass('correct').removeClass('wrong');});
    }).trigger('click');  // Execute on page load (stops browser caching them on page refresh)
    // Instructions
    $('#transcription-exercise-controls-instructions').on('click', function(){
        $('#transcription-exercise-instructions').toggle();
        // Hide other controldropdown instances
        $('.transcription-exercise-controlsdropdown').not('#transcription-exercise-instructions').hide();
    });
    // Full solutions
    $('#transcription-exercise-controls-fullsolution').on('click', function(){
        $('#transcription-exercise-solutions').toggle();
        // Hide other controldropdown instances
        $('.transcription-exercise-controlsdropdown').not('#transcription-exercise-solutions').hide();
    });
    // All correct answers
    $('#transcription-exercise-controls-correctall').on('click', function(){
        // Toggle global var
        showCorrectAnswerInlineAll = !showCorrectAnswerInlineAll;
        // Toggle elements
        var element_beforepart = '.transcription-exercise-input-line-word-answer-beforepart';
        var element_text = '.transcription-exercise-input-line-word-answer';
        var element_afterpart = '.transcription-exercise-input-line-word-answer-afterpart';
        var elements = $([element_beforepart, element_text, element_afterpart].join(', '));
        if (showCorrectAnswerInlineAll) elements.addClass('active');
        else elements.removeClass('active');
    });
    // Current correct answer
    $('#transcription-exercise-controls-correctcurrent').on('click', function(){
        // Toggle global var
        showCorrectAnswerInlineIndividual = !showCorrectAnswerInlineIndividual;
        // Only continue if there's an active image part and not all are active
        if (lastActiveDocumentImagePartId && !showCorrectAnswerInlineAll){
            var element_beforepart = '#transcription-exercise-input-line-word-answer-beforepart-' + lastActiveDocumentImagePartId;
            var element_text = '#transcription-exercise-input-line-word-answer-' + lastActiveDocumentImagePartId;
            var element_afterpart = '#transcription-exercise-input-line-word-answer-afterpart-' + lastActiveDocumentImagePartId;

            var elements = $([element_beforepart, element_text, element_afterpart].join(', '));
            // Toggle elements
            if (showCorrectAnswerInlineIndividual) elements.addClass('active');
            else elements.removeClass('active');
        }
    });
    // Scores details
    $('#transcription-exercise-controls-scores').on('click', function(){
        // Set score text
        setTranscriptionScoresText();
        // Show/hide scores
        $('#transcription-exercise-scores').toggle();
        // Hide other controldropdown instances
        $('.transcription-exercise-controlsdropdown').not('#transcription-exercise-scores').hide();
    });
    // Position Details
    $('#transcription-exercise-controls-positiondetails').on('click', function(){
        $('.transcription-exercise-input-linecount, .transcription-exercise-input-line-word-count').toggleClass('active');
    });

    // Score transcription attempts
    function scoreTranscriptionAttempt(inputField, ignoreWrongAnswers=false){
        // Class names
        var classCorrect = 'correct';
        var classWrong = 'wrong';
        // Answers
        var answerAttempt = inputField.val();
        var answerCorrectList = inputField.attr('data-correctanswer').split("|");
        // Only score answer if a value provided
        if (answerAttempt !== ''){
            // Correct - if the answer attempt is in list of correct answers
            if (answerCorrectList.indexOf(answerAttempt) > -1){
                inputField.addClass(classCorrect).removeClass(classWrong);
                setTranscriptionScoresText();
                return;  // End function here
            }
            // Wrong
            else if (!ignoreWrongAnswers){
                inputField.addClass(classWrong).removeClass(classCorrect);
                setTranscriptionScoresText();
                return;  // End function here
            }
        }
        // Remove correct/wrong score, if not marked as correct/wrong by this point
        inputField.removeClass(classWrong).removeClass(classCorrect);
        setTranscriptionScoresText();
    }
    // Score transcription attempt as correct/incorrect when focus out of an input
    $('.transcription-exercise-input-line-word').on('focusout', function(){
        scoreTranscriptionAttempt($(this));
    });
    // Score transcription attempt as correct whilst user types
    $('.transcription-exercise-input-line-word').on('input', function(){
        scoreTranscriptionAttempt($(this), true);
    });
    // Set the score text for transcriptions
    function setTranscriptionScoresText(){
        // Get counts
        var count_available = $('.transcription-exercise-input-line-word').length;
        var count_wrong = $('.transcription-exercise-input-line-word.wrong').length;
        var count_correct = $('.transcription-exercise-input-line-word.correct').length;
        var count_answered = count_wrong + count_correct;
        var count_unanswered = count_available - count_answered;
        var percentage = Math.round((count_correct / count_available) * 100);
        // Set scores text
        $('#transcription-exercise-scores-percentage').text(percentage + '%');
        $('#transcription-exercise-scores-available').text(count_available);
        $('#transcription-exercise-scores-unanswered').text(count_unanswered);
        $('#transcription-exercise-scores-answered').text(count_answered);
        $('#transcription-exercise-scores-wrong').text(count_wrong);
        $('#transcription-exercise-scores-correct').text(count_correct);
    }

    // Click 'enter' to move focus to next transcription input
    $('.transcription-exercise-input-line-word').keydown(function(e){
        var key = e.charCode ? e.charCode : e.keyCode ? e.keyCode : 0;
        if (key == 13) {
            e.preventDefault();
            var inputs = $(this).closest('.transcription-exercise-input').find('.transcription-exercise-input-line-word');
            inputs.eq( inputs.index(this)+ 1 ).focus();
        }
    });

    // Set a 'reveal' class to document image parts that overlay image when user hovers over them
    $('.detail-images-image-parts-part, .transcription-exercise-input-line-word').hover(
        // Hover starts
        function(){
            var documentImagePartId = $(this).attr('id').split('-').slice('-1')[0];
            $('#detail-images-image-parts-part-' + documentImagePartId + ', #transcription-exercise-input-line-word-' + documentImagePartId).addClass('reveal');
        },
        // Hover ends
        function(){
            var documentImagePartId = $(this).attr('id').split('-').slice('-1')[0];
            $('#detail-images-image-parts-part-' + documentImagePartId + ', #transcription-exercise-input-line-word-' + documentImagePartId).removeClass('reveal');
        }
    );

    // Connect document image part occurences: image overlays and transcription inputs
    $('.transcription-exercise-input-line-word').on('focus', function(){
        var documentImagePartId = $(this).attr('id').split('-').slice('-1')[0];
        $('.detail-images-image-parts-part').removeClass('active');
        $('#detail-images-image-parts-part-' + documentImagePartId).addClass('active');
        // Hide the active correct answer inline (individual) if focussing on a different part
        if (showCorrectAnswerInlineIndividual && lastActiveDocumentImagePartId !== documentImagePartId){
            $('#transcription-exercise-controls-correctcurrent').first().trigger('click');  // TODO update this with the correct button when it's been created
        }
        lastActiveDocumentImagePartId = documentImagePartId;  // Update last active global var
    }).on('focusout', function(){
        // When an input is no longer focussed on, ensure image overlay isn't left active
        $('.detail-images-image-parts-part').removeClass('active');
    });
    $('.detail-images-image-parts-part').on('click', function(){
        var documentImagePartId = $(this).attr('id').split('-').slice('-1')[0];
        $('#transcription-exercise-input-line-word-' + documentImagePartId).focus();
    });

    // Document Image Part Popup
    $('.transcription-exercise-input-line-word').on('focus', function(){
        // Move the preview above the current image part
        var posX = 400;
        var posY = 400;

        // Set the image in the preview as the current image part's cropped image
        var img = $('.detail-images-image.active').first().find('img');
        $('#transcription-exercise-part-popup-image').attr('src', img.attr('src'));

        // Set the help text for this document image part in the popup
        var helptext = $('#transcription-exercise-input-line-word-' + lastActiveDocumentImagePartId).attr('data-helptext');
        if (!helptext) helptext = '';  // Set as an empty string to clear parts with no help text
        $('#transcription-exercise-part-popup-helptext').text(helptext);
    });

    // Choose/show an image and accompanying transcription
    $('#detail-images-controls-chooseimage').on('change', function(){
        // Go to the correct tab
        $('li#transcription').trigger('click');
        // Hide any existing dropdown content
        $('.transcription-exercise-controlsdropdown').hide();

        var imageId = $(this).find(":selected").val();
        // Remove 'active' from existing image (and related content)
        $('.detail-images-image.active, .transcription-exercise.active, .transcription-exercise-solutions-solution.active').removeClass('active');
        // Mark this image (and related content) as 'active'
        $('#detail-images-image-' + imageId + ', #transcription-exercise-' + imageId + ', #transcription-exercise-solutions-solution-' + imageId).addClass('active');
        // Set the 'Download image' link location
        var imageUrl = $('#detail-images-image-' + imageId).find('img').attr('src');
        $('#detail-images-controls-downloadimage a').attr('href', imageUrl);
    }).trigger('change');  // Show the first image by default on page load


    // Image Controls

    // Zoom
    function zoomInOrOut(zoomOut=false){
        let slider = $('#detail-images-controls-zoom-range-slider');
        let currentVal = slider.val();
        let changeVal = (zoomOut ? 0.7 : 1.3);
        slider.val(currentVal * changeVal).trigger('input');
    }
    // Zoom: Out
    $('#detail-images-controls-zoom-out').on('click', function(){
        zoomInOrOut(true);
    });
    // Zoom: In
    $('#detail-images-controls-zoom-in').on('click', function(){
        zoomInOrOut();
    });
    // Zoom: Slider
    function zoomItemImage(zoomLevel){
        $('.detail-images-image').css({'transform': 'scale(' + zoomLevel + ', ' + zoomLevel + ')', 'transform-origin': '0% 0%'});
    }
    // Set zoom via slider
    $('#detail-images-controls-zoom-range-slider').on('input', function(){
        let zoomLevel = $(this).val() / 100;
        zoomItemImage(zoomLevel);
    }).on('change', function(){$(this).blur();});  // Stops the tooltip from remaining visible when focus stays on range slider
    // Set zoom/scale for 100% width of the image in the container
    function zoomFullWidth(){
        var imageWidth = $('.detail-images-image.active').first().find('img').width();
        var imageContainerWidth = $('#detail-images-container').width();
        var scale = (imageContainerWidth / imageWidth) * 100;
        $('#detail-images-controls-zoom-range-slider').val(scale).trigger('input');
    }

    // Reset image viewer to default
    $('#detail-images-controls-reset').on('click', function(){
        zoomFullWidth();
        $('#detail-images-container').scrollTop(0).scrollLeft(0);
    }).trigger('click'); // Reset the image viewer on page load

});
</script>

{% endblock %}